<!DOCTYPE html>
<html lang="de">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Surf In The Cloud: TYPO3 Surf-Deployments nach EC2</title>
  <meta name="description" content="Nachdem mir in den letzten Tagen das manuelle Deployment meiner kleinen Neos-Seite zu aufwändig wurde, beschloss ich, dieses Deployment über TYPO3 Surf zu au...">

  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.9/css/all.css" integrity="sha384-5SOiIsAziJl6AWe0HWRKTXlfcSHKmYV4RBF18PPJ173Kzn7jzMyFuTtk8JA7QQG1" crossorigin="anonymous">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.5.0/css/mdb.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/fonts.css">

  <link rel="canonical" href="https://www.martin-helmich.de/de/blog/typo3-surf-deployment-ec2.html">

  <link rel="alternate" type="application/rss+xml" title="martin-helmich.de" href="https://www.martin-helmich.de/feed.xml">

  
    <link rel="alternate" hreflang="en" href="/en/blog/typo3-surf-deployment-ec2.html">
  

</head>


  <body>

    <div class="main">
      <div  class="blog-landing" style="background-image: url(/assets/headers/clouds.jpg)">
      <nav class="navbar navbar-expand-lg navbar-dark elegant-color">
  <div class="container">
    <a class="navbar-brand" href="/">martin-helmich.de</a>

    <!-- Collapse button -->
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar" aria-controls="basicExampleNav"
        aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse">
      <ul class="navbar-nav mr-auto">
        
          
          
          <li class="nav-item normal">
            <a class="nav-link" href="/">Blog</a>
          </li>
        
          
          
          <li class="nav-item normal">
            <a class="nav-link" href="/de/ueber-mich.html">Über mich</a>
          </li>
        
          
          
          <li class="nav-item normal">
            <a class="nav-link" href="/de/veroeffentlichungen.html">Veröffentlichungen</a>
          </li>
        
      </ul>

      
      <ul class="navbar-nav navbar-right">
        <li class="nav-item dropdown">
          <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">
            Deutsch
            <span class="caret"></span>
          </a>
          <div class="dropdown-menu dropdown-primary">
            <a class="active dropdown-item" href="/de/blog/typo3-surf-deployment-ec2.html">Deutsch</a>
            <a class="normal dropdown-item" href="/en/blog/typo3-surf-deployment-ec2.html">Englisch</a>
          </div>
        </li>
      </ul>
      
    </div>
  </div>
</nav>


        <div class="container attribution">
          
          <a href="https://www.flickr.com/photos/photographyburns/7594366574" target="_blank">
            CC BY, Brandon Burns
          </a>
          
        </div>
      </div>

      <div class="container primary">
        <div class="content main-content">
          <div class="post-content">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <p class="post-meta text-center font-italic">
      Geschrieben am
      
      <time datetime="2015-04-20T19:42:28+00:00" itemprop="datePublished">
        20. April 2015
      </time>
      

      
    </p>

    
      <div class="my-alert row info-color-dark white-text z-depth-1">
      <div class="col-sm-12">
        <span class="icon">
          <i class="fa fa-globe"></i>
        </span>
        <div class="my-alert-body">
          <strong>Hello! </strong> 
        This article is also <a href="/en/blog/typo3-surf-deployment-ec2.html">available in English</a>!
      
        </div>
      </div>
    </div>
    

    <h1 class="post-title" itemprop="name headline">Surf In The Cloud: TYPO3 Surf-Deployments nach EC2</h1>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Nachdem mir in den letzten Tagen das manuelle Deployment meiner kleinen Neos-Seite zu aufwändig wurde, beschloss ich, dieses Deployment über TYPO3 Surf zu automatisieren. Da ich auch beruflich viel mit Surf zu tun habe, war das Deployment schnell geschrieben. Dennoch war ich mit der ersten Version meines Deployments noch nicht ganz glücklich:</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span></span><span class="lineno">1 </span><span class="cp">&lt;?php</span>
<span class="lineno">2 </span>
<span class="lineno">3 </span><span class="nv">$node</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\TYPO3\Surf\Domain\Model\Node</span><span class="p">(</span><span class="s2">&quot;i-54932495&quot;</span><span class="p">);</span>
<span class="lineno">4 </span><span class="nv">$node</span><span class="o">-&gt;</span><span class="na">setHostname</span><span class="p">(</span><span class="s2">&quot;ec2-52-28-61-14.eu-central-1.compute.amazonaws.com&quot;</span><span class="p">);</span>
<span class="lineno">5 </span><span class="nv">$node</span><span class="o">-&gt;</span><span class="na">setOption</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;neos&quot;</span><span class="p">);</span>
<span class="lineno">6 </span>
<span class="lineno">7 </span><span class="c1">// ...</span></code></pre></figure>

<p>Was würde passieren, wenn ich meine winzige Micro-EC2-Instanz einmal löschen würde? Oder falls ich beschlösse, meine Seite auf zwei (winzigen) Micro-Instanzen zu betreiben? Deutlich eleganter ist es, sich diese Informationen einfach direkt von der EC2-API zu laden. Hierzu kann das AWS-SDK für PHP genutzt werden, welches einfach per Composer bezogen werden kann:</p>

<pre><code>$ composer require aws/aws-sdk-php
</code></pre>

<p>Und nun zahlt sich auch aus, dass Deployment-Definitionen in TYPO3 Surf einfach nur einfache PHP-Dateien sind. So kann man einfach alle Instanzen (optional gefiltert nach einem bestimmten Tag) aus der AWS-API laden und als Node dem Deployment hinzufügen:</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span></span><span class="lineno"> 1 </span><span class="cp">&lt;?php</span>
<span class="lineno"> 2 </span><span class="nv">$ec2</span> <span class="o">=</span> <span class="nx">\Aws\Ec2\Ec2Client</span><span class="o">::</span><span class="na">factory</span><span class="p">([</span><span class="s1">&#39;profile&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;region&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;eu-central-1&#39;</span><span class="p">]);</span>
<span class="lineno"> 3 </span>
<span class="lineno"> 4 </span><span class="nv">$response</span> <span class="o">=</span> <span class="nv">$ec2</span><span class="o">-&gt;</span><span class="na">describeInstances</span><span class="p">([</span>
<span class="lineno"> 5 </span>    <span class="s1">&#39;Filters&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
<span class="lineno"> 6 </span>        <span class="p">[</span><span class="s1">&#39;Name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;tag:purpose&#39;</span><span class="p">,</span> <span class="s1">&#39;Values&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;mhde-prod&#39;</span><span class="p">]],</span>
<span class="lineno"> 7 </span>        <span class="p">[</span><span class="s1">&#39;Name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;instance-state-name&#39;</span><span class="p">,</span> <span class="s1">&#39;Values&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;running&#39;</span><span class="p">]]</span>
<span class="lineno"> 8 </span>    <span class="p">]</span>
<span class="lineno"> 9 </span><span class="p">]);</span>
<span class="lineno">10 </span>
<span class="lineno">11 </span><span class="nv">$application</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\TYPO3\Surf\Application\TYPO3\Flow</span><span class="p">(</span><span class="s1">&#39;martin-helmich.de&#39;</span><span class="p">);</span>
<span class="lineno">12 </span>
<span class="lineno">13 </span><span class="k">foreach</span> <span class="p">(</span><span class="nv">$response</span><span class="p">[</span><span class="s1">&#39;Reservations&#39;</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$reservation</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">14 </span>    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$reservation</span><span class="p">[</span><span class="s1">&#39;Instances&#39;</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$instance</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">15 </span>        <span class="nv">$node</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\TYPO3\Surf\Domain\Model\Node</span><span class="p">(</span><span class="nv">$instance</span><span class="p">[</span><span class="s1">&#39;InstanceId&#39;</span><span class="p">]);</span>
<span class="lineno">16 </span>        <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">setHostname</span><span class="p">(</span><span class="nv">$instance</span><span class="p">[</span><span class="s1">&#39;PublicDnsName&#39;</span><span class="p">]);</span>
<span class="lineno">17 </span>        <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">setOption</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;neos&#39;</span><span class="p">);</span>
<span class="lineno">18 </span>        <span class="nv">$application</span><span class="o">-&gt;</span><span class="na">addNode</span><span class="p">(</span><span class="nv">$node</span><span class="p">);</span>
<span class="lineno">19 </span>    <span class="p">}</span>
<span class="lineno">20 </span><span class="p">}</span>
<span class="lineno">21 </span>
<span class="lineno">22 </span><span class="c1">// ...</span></code></pre></figure>

<p>Und fertig! Nie wieder neue Server im Deployment konfigurieren.</p>

  </div>

  <h2 id="comments">Kommentare</h2>

  <div id="disqus_thread"  class="helmich-homepage-blogarticle"></div>
</article>
<script type="text/javascript">
var disqus_config = function () {
    this.page.url = "https://www.martin-helmich.de/de/blog/typo3-surf-deployment-ec2.html";
    this.page.identifier = "72b00a3c-7625-a7cb-75ee-a507ccd8a3e4";
    this.page.title = "Surf In The Cloud: TYPO3 Surf-Deployments nach EC2";
};

(function() {  // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    
    s.src = 'https://martinhelmichde.disqus.com/embed.js';
    
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();
</script>
<noscript>
Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments
powered by Disqus.</a>
</noscript>
</div>
        </div>
      </div>
    </div>

    

<footer class="page-footer font-small stylish-color pt-4 z-depth-1">
  <div class="container">
    <div class="row">
      <div class="col-sm-4">
        <h5>Veröffentlichungen</h5>
        <ul>
          
          
            <li>
              <strong><a href="/de/veroeffentlichungen.html">Rust: Ein Blick auf die C/C++-Alternative</a></strong>
              am 01. Juli 2020
            </li>
          
            <li>
              <strong><a href="/de/veroeffentlichungen.html">Microservices: Mit Tools wie Jaeger die Übersicht behalten</a></strong>
              am 01. April 2020
            </li>
          
            <li>
              <strong><a href="/de/veroeffentlichungen.html">Kommunikation zwischen Browser & Server: Mit Publish/Subscribe mehr Komplexität abbilden</a></strong>
              am 28. August 2019
            </li>
          
            <li>
              <strong><a href="/de/veroeffentlichungen.html">Automatisierung mit Kubernetes Operators</a></strong>
              am 01. Mai 2019
            </li>
          
            <li>
              <strong><a href="/de/veroeffentlichungen.html">Praxiswissen TYPO3 CMS 9</a></strong>
              am 28. März 2019
            </li>
          
        </ul>
      </div>
      <div class="col-sm-4">
        <h5>
          Blog-Artikel
        </h5>
        <ul>
          
          
            <li>
              <strong><a href="/https:/t3n.de/magazin/microservices-mit-tools-wie-die-249408/">Microservices: Mit Tools wie Jaeger die Übersicht behalten</a></strong>
              am 04. Juli 2020
            </li>
          
            <li>
              <strong><a href="/https:/jaxenter.de/kubernetes/automatisierung-kubernetes-operators-88189">Automatisierung mit Kubernetes Operators</a></strong>
              am 04. Februar 2020
            </li>
          
            <li>
              <strong><a href="/https:/t3n.de/magazin/besser-entwickeln-mit-continuous-247076/">Besser entwickeln mit Devops-Praktiken: Continuous Delivery mit Kubernetes</a></strong>
              am 07. April 2019
            </li>
          
            <li>
              <strong><a href="/de/blog/typo3-cms-docker.html">Gut eingepackt: TYPO3 CMS in Docker betreiben</a></strong>
              am 22. März 2019
            </li>
          
            <li>
              <strong><a href="/en/blog/kubernetes-crd-client.html">Kubernetes-CRDs über die client-go-Bibliothek auslesen</a></strong>
              am 28. März 2018
            </li>
          
        </ul>
      </div>
      <div class="col-sm-4">
        <h5>
          Menü
        </h5>
        <ul>
          
            <li><a href="/de/impressum.html">Impressum</a></li>
          
        </ul>
      </div>
    </div>
  </div>
  <div class="footer-copyright py-3 text-center">
    Martin Helmich 2018
  </div>
</footer>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.13.0/umd/popper.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.5.0/js/mdb.min.js"></script>
<script type="text/javascript">
$("#martin-grumpy").mouseover(function() {
  $(this).attr("src", "/assets/martin-happy.jpg");
});
$("#martin-grumpy").mouseout(function() {
  $(this).attr("src", "/assets/martin-grumpy.jpg");
});
</script>

  </body>

</html>
