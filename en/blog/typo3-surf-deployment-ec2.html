<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Surf In The Cloud: TYPO3 Surf-Deployments nach EC2</title>
  <meta name="description" content="After a while, manually deploying my tiny site got a little tedious. As a solution, I decided to automate this deployment using TYPO3 Surf. Since I’m also wo...">

  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.9/css/all.css" integrity="sha384-5SOiIsAziJl6AWe0HWRKTXlfcSHKmYV4RBF18PPJ173Kzn7jzMyFuTtk8JA7QQG1" crossorigin="anonymous">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.5.0/css/mdb.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/fonts.css">

  <link rel="canonical" href="https://www.martin-helmich.de/en/blog/typo3-surf-deployment-ec2.html">

  <link rel="alternate" type="application/rss+xml" title="martin-helmich.de" href="https://www.martin-helmich.de/feed.xml">

  
    <link rel="alternate" hreflang="de" href="/de/blog/typo3-surf-deployment-ec2.html">
  

</head>


  <body>

    <div class="main">
      <div  class="blog-landing" style="background-image: url(/assets/headers/clouds.jpg)">
      <nav class="navbar navbar-expand-lg navbar-dark elegant-color">
  <div class="container">
    <a class="navbar-brand" href="/en/blog.html">martin-helmich.de</a>

    <!-- Collapse button -->
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar" aria-controls="basicExampleNav"
        aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse">
      <ul class="navbar-nav mr-auto">
        
          
          
          <li class="nav-item normal">
            <a class="nav-link" href="/en/blog.html">Blog</a>
          </li>
        
          
          
          <li class="nav-item normal">
            <a class="nav-link" href="/en/about-me.html">About me</a>
          </li>
        
          
          
          <li class="nav-item normal">
            <a class="nav-link" href="/en/publications.html">Publications</a>
          </li>
        
      </ul>

      
      <ul class="navbar-nav navbar-right">
        <li class="nav-item dropdown">
          <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">
            English
            <span class="caret"></span>
          </a>
          <div class="dropdown-menu dropdown-primary">
            <a class="normal dropdown-item" href="/de/blog/typo3-surf-deployment-ec2.html">German</a>
            <a class="active dropdown-item" href="/en/blog/typo3-surf-deployment-ec2.html">English</a>
          </div>
        </li>
      </ul>
      
    </div>
  </div>
</nav>


        <div class="container attribution">
          
          <a href="https://www.flickr.com/photos/photographyburns/7594366574" target="_blank">
            CC BY, Brandon Burns
          </a>
          
        </div>
      </div>

      <div class="container primary">
        <div class="content main-content">
          <div class="post-content">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <p class="post-meta text-center font-italic">
      Written on
      
      <time datetime="2015-04-20T19:42:28+00:00" itemprop="datePublished">
        20. April 2015
      </time>
      

      
    </p>

    
      <div class="my-alert row info-color-dark white-text z-depth-1">
      <div class="col-sm-12">
        <span class="icon">
          <i class="fa fa-globe"></i>
        </span>
        <div class="my-alert-body">
          <strong>Hallo! </strong> 
        Dieser Artikel steht auch <a href="/de/blog/typo3-surf-deployment-ec2.html">auf Deutsch zur Verfügung</a>!
      
        </div>
      </div>
    </div>
    

    <h1 class="post-title" itemprop="name headline">Surf In The Cloud: TYPO3 Surf-Deployments nach EC2</h1>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>After a while, manually deploying my tiny site got a little tedious. As a solution, I decided to automate this deployment using TYPO3 Surf. Since I’m also working with Surf on the job, that task was not too difficult for me. However, the first version of my deployment script did not really “feel” good (you know that feeling when you have built something that works well, but just doesn’t “feel” good, don’t you?):</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="nv">$node</span> <span class="o">=</span> <span class="k">new</span> <span class="err">\</span><span class="nf">TYPO3\Surf\Domain\Model\Node</span><span class="p">(</span><span class="s2">"i-54932495"</span><span class="p">);</span>
<span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">setHostname</span><span class="p">(</span><span class="s2">"ec2-52-28-61-14.eu-central-1.compute.amazonaws.com"</span><span class="p">);</span>
<span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">setOption</span><span class="p">(</span><span class="s2">"username"</span><span class="p">,</span> <span class="s2">"neos"</span><span class="p">);</span>

<span class="c1">// ...</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>What would happen, should I decide to delete my teeny-tiny-micro EC2 instance? Or if I decided to operate my site on two (teeny-tiny) micro instances? It appears a lot more elegant to simply retrieve the information on the target nodes directly from the EC2 API. For this, you can use the AWS SDK for php, which can be easily installed using Composer:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ composer require aws/aws-sdk-php
</code></pre></div></div>

<p>Here it pays off that in TYPO3 Surf, deployment definitions are simply executable PHP files. That way, you can simply query the AWS API for all instances (optionally filtered by status and a certain tag) and add as a new node to the deployment:</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>
<span class="nv">$ec2</span> <span class="o">=</span> <span class="err">\</span><span class="nc">Aws\Ec2\Ec2Client</span><span class="o">::</span><span class="nf">factory</span><span class="p">([</span><span class="s1">'profile'</span> <span class="o">=&gt;</span> <span class="s1">'default'</span><span class="p">,</span> <span class="s1">'region'</span> <span class="o">=&gt;</span> <span class="s1">'eu-central-1'</span><span class="p">]);</span>

<span class="nv">$response</span> <span class="o">=</span> <span class="nv">$ec2</span><span class="o">-&gt;</span><span class="nf">describeInstances</span><span class="p">([</span>
    <span class="s1">'Filters'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="p">[</span><span class="s1">'Name'</span> <span class="o">=&gt;</span> <span class="s1">'tag:purpose'</span><span class="p">,</span> <span class="s1">'Values'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'mhde-prod'</span><span class="p">]],</span>
        <span class="p">[</span><span class="s1">'Name'</span> <span class="o">=&gt;</span> <span class="s1">'instance-state-name'</span><span class="p">,</span> <span class="s1">'Values'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'running'</span><span class="p">]]</span>
    <span class="p">]</span>
<span class="p">]);</span>

<span class="nv">$application</span> <span class="o">=</span> <span class="k">new</span> <span class="err">\</span><span class="nf">TYPO3\Surf\Application\TYPO3\Flow</span><span class="p">(</span><span class="s1">'martin-helmich.de'</span><span class="p">);</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$response</span><span class="p">[</span><span class="s1">'Reservations'</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$reservation</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$reservation</span><span class="p">[</span><span class="s1">'Instances'</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$instance</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$node</span> <span class="o">=</span> <span class="k">new</span> <span class="err">\</span><span class="nf">TYPO3\Surf\Domain\Model\Node</span><span class="p">(</span><span class="nv">$instance</span><span class="p">[</span><span class="s1">'InstanceId'</span><span class="p">]);</span>
        <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">setHostname</span><span class="p">(</span><span class="nv">$instance</span><span class="p">[</span><span class="s1">'PublicDnsName'</span><span class="p">]);</span>
        <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">setOption</span><span class="p">(</span><span class="s1">'username'</span><span class="p">,</span> <span class="s1">'neos'</span><span class="p">);</span>
        <span class="nv">$application</span><span class="o">-&gt;</span><span class="nf">addNode</span><span class="p">(</span><span class="nv">$node</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ...</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>And done! Now I never again have to configure new servers in the deployment configuration.</p>

  </div>

  <h2 id="comments">Comments</h2>

  <div id="disqus_thread"  class="helmich-homepage-blogarticle"></div>
</article>
<script type="text/javascript">
var disqus_config = function () {
    this.page.url = "https://www.martin-helmich.de/en/blog/typo3-surf-deployment-ec2.html";
    this.page.identifier = "72b00a3c-7625-a7cb-75ee-a507ccd8a3e4";
    this.page.title = "Surf In The Cloud: TYPO3 Surf-Deployments nach EC2";
};

(function() {  // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    
    s.src = 'https://martinhelmichde.disqus.com/embed.js';
    
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();
</script>
<noscript>
Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments
powered by Disqus.</a>
</noscript>
</div>
        </div>
      </div>
    </div>

    

<footer class="page-footer font-small stylish-color pt-4 z-depth-1">
  <div class="container">
    <div class="row">
      <div class="col-sm-4">
        <h5>Publications</h5>
        <ul>
          
          
            <li>
              <strong><a href="/en/publications.html">Praxiswissen TYPO3 CMS 10</a></strong>
              am 04. Dezember 2020
            </li>
          
            <li>
              <strong><a href="/en/publications.html">Rust: Ein Blick auf die C/C++-Alternative</a></strong>
              am 01. Juli 2020
            </li>
          
            <li>
              <strong><a href="/en/publications.html">Microservices: Mit Tools wie Jaeger die Übersicht behalten</a></strong>
              am 01. April 2020
            </li>
          
            <li>
              <strong><a href="/en/publications.html">Kommunikation zwischen Browser & Server: Mit Publish/Subscribe mehr Komplexität abbilden</a></strong>
              am 28. August 2019
            </li>
          
            <li>
              <strong><a href="/en/publications.html">Automatisierung mit Kubernetes Operators</a></strong>
              am 01. Mai 2019
            </li>
          
        </ul>
      </div>
      <div class="col-sm-4">
        <h5>
          Blog articles
        </h5>
        <ul>
          
          
            <li>
              <strong><a href="/https:/t3n.de/magazin/event-sourcing-das-steckt-hinter-250347/">Event Sourcing: How the "software ledger" works
</a></strong>
              am 14. Februar 2021
            </li>
          
            <li>
              <strong><a href="/https:/t3n.de/magazin/microservices-mit-tools-wie-die-249408/">Microservices: Keeping track of things with Jaeger</a></strong>
              am 04. Juli 2020
            </li>
          
            <li>
              <strong><a href="/en/blog/typo3-cms-docker.html">Well contained: Running TYPO3 in Docker</a></strong>
              am 03. Mai 2020
            </li>
          
            <li>
              <strong><a href="/en/blog/kubernetes-crd-client.html">Accessing Kubernetes CRDs from the client-go package</a></strong>
              am 15. April 2020
            </li>
          
            <li>
              <strong><a href="/https:/jaxenter.de/kubernetes/automatisierung-kubernetes-operators-88189">Automation with Kubernetes operators</a></strong>
              am 04. Februar 2020
            </li>
          
        </ul>
      </div>
      <div class="col-sm-4">
        <h5>
          Menu
        </h5>
        <ul>
          
            <li><a href="/de/impressum.html">Legal</a></li>
          
        </ul>
      </div>
    </div>
  </div>
  <div class="footer-copyright py-3 text-center">
    Martin Helmich 2018
  </div>
</footer>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.13.0/umd/popper.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.5.0/js/mdb.min.js"></script>
<script type="text/javascript">
$("#martin-grumpy").mouseover(function() {
  $(this).attr("src", "/assets/martin-happy.jpg");
});
$("#martin-grumpy").mouseout(function() {
  $(this).attr("src", "/assets/martin-grumpy.jpg");
});
</script>

  </body>

</html>
