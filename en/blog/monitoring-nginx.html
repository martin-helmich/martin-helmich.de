<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>NGINX Performance Metrics with Prometheus</title>
  <meta name="description" content="Prometheus is a combination of monitoring tool and time-series databasethat I have come to appreciate highly over the last few months. This articledemonstrat...">

  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.9/css/all.css" integrity="sha384-5SOiIsAziJl6AWe0HWRKTXlfcSHKmYV4RBF18PPJ173Kzn7jzMyFuTtk8JA7QQG1" crossorigin="anonymous">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.5.0/css/mdb.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/fonts.css">

  <link rel="canonical" href="https://www.martin-helmich.de/en/blog/monitoring-nginx.html">

  <link rel="alternate" type="application/rss+xml" title="martin-helmich.de" href="https://www.martin-helmich.de/feed.xml">

  
    <link rel="alternate" hreflang="de" href="/de/blog/monitoring-nginx.html">
  

</head>


  <body>

    <div class="main">
      <div  class="blog-landing" style="background-image: url(/assets/headers/seismograph.jpg)">
      <nav class="navbar navbar-expand-lg navbar-dark elegant-color">
  <div class="container">
    <a class="navbar-brand" href="/en/blog.html">martin-helmich.de</a>

    <!-- Collapse button -->
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar" aria-controls="basicExampleNav"
        aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse">
      <ul class="navbar-nav mr-auto">
        
          
          
          <li class="nav-item normal">
            <a class="nav-link" href="/en/blog.html">Blog</a>
          </li>
        
          
          
          <li class="nav-item normal">
            <a class="nav-link" href="/en/about-me.html">About me</a>
          </li>
        
          
          
          <li class="nav-item normal">
            <a class="nav-link" href="/en/publications.html">Publications</a>
          </li>
        
      </ul>

      
      <ul class="navbar-nav navbar-right">
        <li class="nav-item dropdown">
          <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">
            English
            <span class="caret"></span>
          </a>
          <div class="dropdown-menu dropdown-primary">
            <a class="normal dropdown-item" href="/de/blog/monitoring-nginx.html">German</a>
            <a class="active dropdown-item" href="/en/blog/monitoring-nginx.html">English</a>
          </div>
        </li>
      </ul>
      
    </div>
  </div>
</nav>


        <div class="container attribution">
          
          <a href="https://www.flickr.com/photos/raybouk/8201310617/" target="_blank">
            CC BY, Ray Bouknight
          </a>
          
        </div>
      </div>

      <div class="container primary">
        <div class="content main-content">
          <div class="post-content">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <p class="post-meta text-center font-italic">
      Written on
      
      <time datetime="2017-03-24T10:05:00+00:00" itemprop="datePublished">
        24. März 2017
      </time>
      

      
    </p>

    
      <div class="my-alert row info-color-dark white-text z-depth-1">
      <div class="col-sm-12">
        <span class="icon">
          <i class="fa fa-globe"></i>
        </span>
        <div class="my-alert-body">
          <strong>Hallo! </strong> 
        Dieser Artikel steht auch <a href="/de/blog/monitoring-nginx.html">auf Deutsch zur Verfügung</a>!
      
        </div>
      </div>
    </div>
    

    <h1 class="post-title" itemprop="name headline">NGINX Performance Metrics with Prometheus</h1>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p><a href="http://prometheus.io">Prometheus</a> is a combination of monitoring tool and time-series database
that I have come to appreciate highly over the last few months. This article
demonstrates how Prometheus can be used to visualize and monitor various web
server metrics without changing the configuration of the web server itself.</p>

<p>Metrics are imported into Prometheus by pulling. This means that a monitored
service needs to offer an HTTP endpoint which will be queried by Prometheus in
regular intervals (usually 15 seconds). This endpoint (for example,
<code class="language-plaintext highlighter-rouge">http://&lt;service-name&gt;/metrics</code>) needs to serve a response with the respective
time series data:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http_response_count_total{application="my-application"} 12423
http_response_time_seconds{application="my-application"} 1832745
</code></pre></div></div>

<p>This works really well in Microservice Architectures – here, every service can
implements its own <code class="language-plaintext highlighter-rouge">/metrics</code> endpoint that produces each and every conceivable
metrics.</p>

<h2 id="the-problem">The Problem</h2>

<p>This approach does not work that well when you want to use Prometheus to monitor
performance metrics of (older) web applications served by a traditional LEMP
stack (Linux, NGINX, MySQL, PHP). The reason for this is that a PHP application
typically does not track metrics like the amount of processed requests or the
average request time (or would need to gather this data by itself and then
persist it in a database).</p>

<p>There are multiple connectors available for integrating NGINX web servers with
Prometheus – however, many of those just process the information available on
the NGINX status page offered by the <code class="language-plaintext highlighter-rouge">ngx_http_stub_status_module</code> module (not
enough detail for my use case), or require you to reconfigure the web server to
send its data to another logging server (much too invasive for my cherished
legacy application).</p>

<h2 id="my-solution">My Solution</h2>

<p>My solution to this challenge is my own Exporter that can generate performance
metrics from existing NGINX access logs. This exporter is available as
<a href="https://github.com/martin-helmich/prometheus-nginxlog-exporter">Open Source on Github</a>, and exports various metrics based on an
existing <code class="language-plaintext highlighter-rouge">access.log</code> file:</p>

<ul>
  <li>Number of processed requests per HTTP request method and response status</li>
  <li>The total sum of time needed for processing HTTP requests per HTTP request
method and status (together with the first metrics, this can be used to
compute the average response time)</li>
  <li>The total sum of the “Upstream Time”, which is the time that NGINX spent on
waiting for PHP-FPM or other FastCGI modules.</li>
  <li>Various quantiles of the response times and upstream times</li>
</ul>

<h2 id="configuration">Configuration</h2>

<p>The NGINX exporter is configured using an HCL config file. In this config file,
you can configure multiple “namespaces” – there will then be exported as
separate sets of metrics. Have a look at the following configuration file as an
example:</p>

<figure class="highlight"><pre><code class="language-tf" data-lang="tf"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="code"><pre><span class="nx">listen</span> <span class="p">{</span>
  <span class="nx">port</span> <span class="p">=</span> <span class="mi">4040</span>
  <span class="nx">address</span> <span class="p">=</span> <span class="s2">"0.0.0.0"</span>
<span class="p">}</span>

<span class="nx">namespace</span> <span class="s2">"app1"</span> <span class="p">{</span>
  <span class="nx">format</span> <span class="p">=</span> <span class="s2">"</span><span class="err">$</span><span class="s2">remote_addr - </span><span class="err">$</span><span class="s2">remote_user [</span><span class="err">$</span><span class="s2">time_local] </span><span class="se">\"</span><span class="err">$</span><span class="s2">request</span><span class="se">\"</span><span class="s2"> </span><span class="err">$</span><span class="s2">status </span><span class="err">$</span><span class="s2">body_bytes_sent </span><span class="se">\"</span><span class="err">$</span><span class="s2">http_referer</span><span class="se">\"</span><span class="s2"> </span><span class="se">\"</span><span class="err">$</span><span class="s2">http_user_agent</span><span class="se">\"</span><span class="s2"> </span><span class="se">\"</span><span class="err">$</span><span class="s2">http_x_forwarded_for</span><span class="se">\"</span><span class="s2">"</span>
  <span class="nx">source_files</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"/var/log/nginx/access.log"</span><span class="p">]</span>
  <span class="nx">labels</span> <span class="p">{</span>
    <span class="nx">app</span> <span class="p">=</span> <span class="s2">"my-application"</span>
    <span class="nx">environment</span> <span class="p">=</span> <span class="s2">"production"</span>
    <span class="nx">foo</span> <span class="p">=</span> <span class="s2">"bar"</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>The exporter starts its own HTTP server that listens on the configured IP
address and port (by default, <code class="language-plaintext highlighter-rouge">0.0.0.0:4040</code>). Using the URL
<code class="language-plaintext highlighter-rouge">http://&lt;IP&gt;:4040/metrics</code>, Prometheus can then scape the respective performance
metrics.</p>

<p>The namespace name (<code class="language-plaintext highlighter-rouge">app1</code>, in this case) will later be used in the name of the
exported metrics – for example, <code class="language-plaintext highlighter-rouge">app1_http_response_time_seconds</code>. The format
(<code class="language-plaintext highlighter-rouge">format</code>) describes the format in which NGINX writes its access logs (for more
information, refer to <a href="http://nginx.org/en/docs/http/ngx_http_log_module.html#log_format">the documentation</a>).</p>

<h2 id="starting-the-exporter">Starting the Exporter</h2>

<p>The exporter is a statically compiled Go binary, that you can install
immediately after downloading:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://github.com/martin-helmich/prometheus-nginxlog-exporter/releases/download/v1.0.0/prometheus-nginxlog-exporter
./prometheus-nginxlog-exporter -config-file /pfad/zur/config.hcl
</code></pre></div></div>

<p>To ensure that the exporter starts automatically on system startup, you can
configure a systemd unit (starting at Debian 8, Ubuntu 16.04 or CentOS 7).
Place this file at <code class="language-plaintext highlighter-rouge">/etc/systemd/system/prometheus-nginxlog-exporter.service</code>:</p>

<figure class="highlight"><pre><code class="language-ini" data-lang="ini"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="code"><pre><span class="nn">[Unit]</span>
<span class="py">Description</span><span class="p">=</span><span class="s">NGINX metrics exporter for Prometheus</span>
<span class="py">After</span><span class="p">=</span><span class="s">network-online.target</span>

<span class="nn">[Service]</span>
<span class="py">ExecStart</span><span class="p">=</span><span class="s">/usr/local/bin/prometheus-nginxlog-exporter -config-file /etc/prometheus-nginxlog-exporter.hcl</span>
<span class="py">Restart</span><span class="p">=</span><span class="s">always</span>
<span class="py">ProtectSystem</span><span class="p">=</span><span class="s">full</span>
<span class="py">CapabilityBoundingSet</span><span class="p">=</span>

<span class="nn">[Install]</span>
<span class="py">WantedBy</span><span class="p">=</span><span class="s">multi-user.target</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Note that this unit file expects the executable to be located at
<code class="language-plaintext highlighter-rouge">/usr/local/bin/prometheus-nginxlog-exporter</code> and the configuration file to be
located at <code class="language-plaintext highlighter-rouge">/etc/prometheus-nginxlog-exporter.hcl</code>. Of course, you can adjust
these paths as required.</p>

<h2 id="the-result">The Result</h2>

<p>I have been operating the <code class="language-plaintext highlighter-rouge">prometheus-nginxlog-exporter</code> in production for some
time,now. Especially together with <a href="https://grafana.com/">Grafana</a>, you can easily create
some excellent reports and monitoring dashboards:</p>

<p><img src="https://www.martin-helmich.de/assets/posts/prometheus-nginx-monitoring.png" alt="NGINX monitoring in action" /></p>

<p>The diagrams in the screenshot above were generated from the following
Prometheus queries:</p>

<ul>
  <li>Average response time: <code class="language-plaintext highlighter-rouge">sum(rate(app_http_response_time_seconds_sum[5m])) by (instance) / sum(rate(app_http_response_time_seconds_count[5m])) by (instance)</code></li>
  <li>Requests per second: <code class="language-plaintext highlighter-rouge">sum(rate(app_http_response_time_seconds_count[1m])) by (instance)</code></li>
  <li>Response time (90% quantile): <code class="language-plaintext highlighter-rouge">app_http_response_time_seconds{quantile="0.9",method="GET",status="200"}</code></li>
  <li>HTTP traffic: <code class="language-plaintext highlighter-rouge">sum(rate(app_http_response_size_bytes[5m])) by (instance)</code></li>
  <li>Status codes per second: <code class="language-plaintext highlighter-rouge">sum(rate(app_http_response_count_total[1m])) by (status)</code></li>
</ul>


  </div>

  <h2 id="comments">Comments</h2>

  <div id="disqus_thread"  class="helmich-homepage-blogarticle"></div>
</article>
<script type="text/javascript">
var disqus_config = function () {
    this.page.url = "https://www.martin-helmich.de/en/blog/monitoring-nginx.html";
    this.page.identifier = "0106ee21-38c1-4ab2-a62e-c7bc3892d653";
    this.page.title = "NGINX Performance Metrics with Prometheus";
};

(function() {  // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    
    s.src = 'https://martinhelmichde.disqus.com/embed.js';
    
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();
</script>
<noscript>
Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments
powered by Disqus.</a>
</noscript>
</div>
        </div>
      </div>
    </div>

    

<footer class="page-footer font-small stylish-color pt-4 z-depth-1">
  <div class="container">
    <div class="row">
      <div class="col-sm-4">
        <h5>Publications</h5>
        <ul>
          
          
            <li>
              <strong><a href="/en/publications.html">Webentwicklung mit Rust</a></strong>
              am 25. Mai 2022
            </li>
          
            <li>
              <strong><a href="/en/publications.html">Event-Sourcing: Das steckt hinter dem Software-Kontenbuch</a></strong>
              am 14. Februar 2021
            </li>
          
            <li>
              <strong><a href="/en/publications.html">Praxiswissen TYPO3 CMS 10</a></strong>
              am 04. Dezember 2020
            </li>
          
            <li>
              <strong><a href="/en/publications.html">Rust: Ein Blick auf die C/C++-Alternative</a></strong>
              am 01. Juli 2020
            </li>
          
            <li>
              <strong><a href="/en/publications.html">Microservices: Mit Tools wie Jaeger die Übersicht behalten</a></strong>
              am 01. April 2020
            </li>
          
        </ul>
      </div>
      <div class="col-sm-4">
        <h5>
          Blog articles
        </h5>
        <ul>
          
          
            <li>
              <strong><a href="/https:/t3n.de/magazin/event-sourcing-das-steckt-hinter-250347/">Event Sourcing: How the "software ledger" works
</a></strong>
              am 14. Februar 2021
            </li>
          
            <li>
              <strong><a href="/https:/t3n.de/magazin/microservices-mit-tools-wie-die-249408/">Microservices: Keeping track of things with Jaeger</a></strong>
              am 04. Juli 2020
            </li>
          
            <li>
              <strong><a href="/en/blog/typo3-cms-docker.html">Well contained: Running TYPO3 in Docker</a></strong>
              am 03. Mai 2020
            </li>
          
            <li>
              <strong><a href="/en/blog/kubernetes-crd-client.html">Accessing Kubernetes CRDs from the client-go package</a></strong>
              am 15. April 2020
            </li>
          
            <li>
              <strong><a href="/https:/jaxenter.de/kubernetes/automatisierung-kubernetes-operators-88189">Automation with Kubernetes operators</a></strong>
              am 04. Februar 2020
            </li>
          
        </ul>
      </div>
      <div class="col-sm-4">
        <h5>
          Menu
        </h5>
        <ul>
          
            <li><a href="/de/impressum.html">Legal</a></li>
          
        </ul>
      </div>
    </div>
  </div>
  <div class="footer-copyright py-3 text-center">
    Martin Helmich 2018
  </div>
</footer>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.13.0/umd/popper.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.5.0/js/mdb.min.js"></script>
<script type="text/javascript">
$("#martin-grumpy").mouseover(function() {
  $(this).attr("src", "/assets/martin-happy.jpg");
});
$("#martin-grumpy").mouseout(function() {
  $(this).attr("src", "/assets/martin-grumpy.jpg");
});
</script>

  </body>

</html>
